<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚µã‚¤ã‚³ãƒ­åˆ¤å®šAPP</title>
  <style>
    :root { --bg: #0b1020; --fg: #e8edf2; --muted:#93a1b1; --accent:#70e1ff; }
    html, body { margin: 0; height: 100%; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
    header { padding: 12px; border-bottom: 1px solid #1d2935; display: flex; align-items: center; justify-content: space-between; }
    h1 { font-size: 16px; margin: 0; }
    main { display: flex; flex-direction: column; height: calc(100% - 50px); }

    .stage { flex: 1; position: relative; display: grid; place-items: center; background: #0e1428; }
    video, canvas { width: 100%; height: auto; max-height: 60vh; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
    #overlay { position: absolute; inset: 0; pointer-events: none; }

    .panel { padding: 10px; border-top: 1px solid #1d2935; background: #0e1428; overflow-y: auto; }
    .row { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin: 8px 0; }
    .col { display: grid; gap: 6px; margin: 10px 0; }
    .btn { appearance: none; cursor: pointer; border: 1px solid #2a3a4a; background: #131d2e; color: var(--fg); padding: 8px 10px; border-radius: 8px; font-size: 14px; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .pill { padding: 4px 8px; border-radius: 100px; background: #101a2a; border: 1px solid #223042; color: var(--muted); font-size: 12px; }
    input, select { font-size: 14px; }
    input[type="range"] { width: 100%; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #111a29; border: 1px solid #223042; color: var(--accent); border-radius: 999px; font-weight: 700; }
    .stat { font-size: 22px; font-weight: 800; }
    .hint { font-size: 12px; color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }

    @media (min-width: 800px) {
      main { flex-direction: row; }
      .stage { flex: 2; }
      .panel { flex: 1; border-top: none; border-left: 1px solid #1d2935; }
      video, canvas { max-width: 100%; max-height: 80vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ² ã‚µã‚¤ã‚³ãƒ­åˆ¤å®šAPP</h1>
    <span id="status" class="pill">åˆæœŸåŒ–ä¸­â€¦</span>
  </header>

  <main>
    <section class="stage">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="overlay"></canvas>
    </section>

    <aside class="panel">
      <div class="row">
        <button id="startBtn" class="btn">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
        <button id="stopBtn" class="btn" disabled>åœæ­¢</button>
        <button id="flipBtn" class="btn">ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
      </div>
      <div class="row">
        <button id="sampleBtn" class="btn">èƒŒæ™¯è‰²ã‚µãƒ³ãƒ—ãƒ«</button>
        <input type="color" id="bgColor" value="#2b4cff" />
      </div>
      <div class="col">
        <label>èƒŒæ™¯ã¨ã®è‰²å·®(Hue)</label>
        <input type="range" id="hueTol" min="5" max="60" value="18" />
        <label>èƒŒæ™¯ã¨ã®è‰²å·®(Sat/Val)</label>
        <input type="range" id="svTol" min="10" max="150" value="60" />
      </div>
      <div class="col">
        <label>ãƒ‰ãƒƒãƒˆæŠ½å‡ºãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚º</label>
        <input type="range" id="blockSize" min="7" max="99" step="2" value="31" />
        <label>ãƒ‰ãƒƒãƒˆæŠ½å‡ºCå€¤</label>
        <input type="range" id="threshC" min="-20" max="20" value="5" />
      </div>

      <div class="row">
        <span class="badge">æ¨å®š: <span id="pred" class="stat">â€“</span></span>
        <span class="pill" id="fps">0 fps</span>
      </div>

      <hr>

      <div class="col">
        <label>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL</label>
        <input id="endpointUrl" placeholder="https://script.google.com/.../exec" style="width:100%;padding:6px;border-radius:6px;border:1px solid #2a3a4a;background:#131d2e;color:var(--fg);" />
        <label>ãƒˆãƒ¼ã‚¯ãƒ³</label>
        <input id="endpointToken" placeholder="ä»»æ„ã®æ–‡å­—åˆ—" style="width:100%;padding:6px;border-radius:6px;border:1px solid #2a3a4a;background:#131d2e;color:var(--fg);" />
        <div class="row">
          <label>è¨˜éŒ²é–“éš”(ç§’)</label>
          <input type="number" id="logInterval" min="1" value="5" style="width:70px;text-align:right;" />
          <button id="logToggleBtn" class="btn">ãƒ­ã‚®ãƒ³ã‚°é–‹å§‹</button>
        </div>
        <div class="row" style="flex-wrap:wrap;gap:4px;">
          <span class="pill">1:<span id="c1">0</span></span>
          <span class="pill">2:<span id="c2">0</span></span>
          <span class="pill">3:<span id="c3">0</span></span>
          <span class="pill">4:<span id="c4">0</span></span>
          <span class="pill">5:<span id="c5">0</span></span>
          <span class="pill">6:<span id="c6">0</span></span>
        </div>
      </div>

      <p class="hint">â€»ã‚¹ãƒãƒ›ã§ã‚‚ç¸¦å‘ããƒ»æ¨ªå‘ãä¸¡å¯¾å¿œã€‚èƒŒæ™¯è‰²ã‚µãƒ³ãƒ—ãƒ«ã§ç²¾åº¦ã‚¢ãƒƒãƒ—ã€‚</p>
    </aside>
  </main>

  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
  <script>
    let video = document.getElementById('video');
    let overlay = document.getElementById('overlay');
    let ctx2d = overlay.getContext('2d');

    let predEl = document.getElementById('pred');
    let statusEl = document.getElementById('status');
    let fpsEl = document.getElementById('fps');
    // logging controls
    const endpointUrl = document.getElementById('endpointUrl');
    const endpointToken = document.getElementById('endpointToken');
    const logInterval = document.getElementById('logInterval');
    const logToggleBtn = document.getElementById('logToggleBtn');
    const countEls = {1:document.getElementById('c1'),2:document.getElementById('c2'),3:document.getElementById('c3'),4:document.getElementById('c4'),5:document.getElementById('c5'),6:document.getElementById('c6')};

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const flipBtn = document.getElementById('flipBtn');
    const sampleBtn = document.getElementById('sampleBtn');
    const bgColor = document.getElementById('bgColor');
    const hueTol = document.getElementById('hueTol');
    const svTol = document.getElementById('svTol');
    const blockSize = document.getElementById('blockSize');
    const threshC = document.getElementById('threshC');

    let facingMode = 'environment';
    let stream = null;
    let pickingBg = false;

    let cap, src, hsv, maskBg, maskFg, kernel, gray, blur, thresh, hier, contours;

    let lastFpsTime = performance.now();
    let frames = 0;

    // åˆ¤å®šã®å®‰å®šåŒ–ç”¨ãƒãƒƒãƒ•ã‚¡
    const recent = [];
    const RECENT_MAX = 30; // ç´„1ç§’ã¶ã‚“ï¼ˆç’°å¢ƒã«ã‚ˆã£ã¦è¦èª¿æ•´ï¼‰

    // é€ä¿¡ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ã‚¦ãƒ³ãƒˆ
    let logTimer = null;
    const localCounts = {1:0,2:0,3:0,4:0,5:0,6:0};

    function setStatus(text) { statusEl.textContent = text; }

    function rgbToHsv(r,g,b){
      const c = document.createElement('canvas');
      c.width=1; c.height=1; const x=c.getContext('2d');
      x.fillStyle = `rgb(${r},${g},${b})`; x.fillRect(0,0,1,1);
      const data = x.getImageData(0,0,1,1).data;
      const mat = new cv.Mat(1,1, cv.CV_8UC3);
      mat.data[0]=data[0]; mat.data[1]=data[1]; mat.data[2]=data[2];
      const hsv = new cv.Mat(); cv.cvtColor(mat, hsv, cv.COLOR_RGB2HSV);
      const H=hsv.data[0], S=hsv.data[1], V=hsv.data[2];
      mat.delete(); hsv.delete();
      return {H,S,V};
    }

    function parseHexColor(hex){
      const m = /^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i.exec(hex);
      if(!m) return {r:0,g:0,b:0};
      return { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) };
    }

    async function startCamera(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode, width: {ideal:1280}, height:{ideal:720} }, audio:false });
        video.srcObject = stream;
        await video.play();
        resizeCanvases();
        setStatus('ã‚«ãƒ¡ãƒ©èµ·å‹•');
        startBtn.disabled = true; stopBtn.disabled = false;
        loop();
      } catch(e){
        console.error(e);
        setStatus('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“');
      }
    }

    function stopCamera(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      startBtn.disabled = false; stopBtn.disabled = true;
    }

    function resizeCanvases(){
      const w = video.videoWidth || 1280; const h = video.videoHeight || 720;
      overlay.width = w; overlay.height = h;
    }

    function onOpenCvReady(){
      setStatus('OpenCV èª­ã¿è¾¼ã¿å®Œäº†');
      startBtn.disabled = false;
      // Pre-allocate mats
      src = new cv.Mat(720, 1280, cv.CV_8UC4);
      hsv = new cv.Mat(); maskBg = new cv.Mat(); maskFg = new cv.Mat();
      gray = new cv.Mat(); blur = new cv.Mat(); thresh = new cv.Mat();
      hier = new cv.Mat(); contours = new cv.MatVector();
      kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(5,5));
      cap = new cv.VideoCapture(video);
    }

    function updateFPS(){
      frames++;
      const now = performance.now();
      if(now - lastFpsTime > 1000){ fpsEl.textContent = `${frames} fps`; frames=0; lastFpsTime = now; }
    }

    function drawBoxAndText(rect, text){
      ctx2d.clearRect(0,0,overlay.width, overlay.height);
      ctx2d.lineWidth = 3; ctx2d.strokeStyle = '#70e1ff'; ctx2d.fillStyle='rgba(112,225,255,.15)';
      ctx2d.beginPath(); ctx2d.rect(rect.x, rect.y, rect.width, rect.height); ctx2d.stroke(); ctx2d.fill();
      ctx2d.font = '24px ui-sans-serif, system-ui'; ctx2d.fillStyle = '#e8edf2';
      ctx2d.fillText(`æ¨å®š: ${text}`, rect.x+6, Math.max(28, rect.y-8));
    }

    function loop(){
      if(!stream){ return; }
      try{
        cap.read(src);
        cv.cvtColor(src, hsv, cv.COLOR_RGBA2HSV);

        // èƒŒæ™¯è‰²ã¨ã®å·®åˆ†ã§å‰æ™¯ï¼ˆã‚µã‚¤ã‚³ãƒ­ï¼‰ã‚’æŠ½å‡º
        const {r,g,b} = parseHexColor(bgColor.value);
        const bgHSV = rgbToHsv(r,g,b);

        // HSVã®ã—ãã„å€¤ç¯„å›²ã‚’ä½œã‚‹
        const hTol = parseInt(hueTol.value,10) | 0;
        const sv = parseInt(svTol.value,10) | 0;
        let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [Math.max(0,bgHSV.H - hTol), Math.max(0,bgHSV.S - sv), Math.max(0,bgHSV.V - sv), 0]);
        let high= new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [Math.min(179,bgHSV.H + hTol), Math.min(255,bgHSV.S + sv), Math.min(255,bgHSV.V + sv), 255]);
        cv.inRange(hsv, low, high, maskBg); // èƒŒæ™¯=ç™½
        cv.bitwise_not(maskBg, maskFg); // å‰æ™¯=ç™½
        low.delete(); high.delete();

        // ãƒã‚¤ã‚ºé™¤å»
        cv.morphologyEx(maskFg, maskFg, cv.MORPH_OPEN, kernel);
        cv.morphologyEx(maskFg, maskFg, cv.MORPH_CLOSE, kernel);

        // ã‚µã‚¤ã‚³ãƒ­è¼ªéƒ­ï¼ˆæœ€å¤§ã®å¡Šï¼‰
        cv.findContours(maskFg, contours, hier, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
        let bestArea = 0, bestRect = null, bestIdx = -1;
        for(let i=0;i<contours.size();i++){
          const cnt = contours.get(i);
          const rect = cv.boundingRect(cnt);
          const area = rect.width * rect.height;
          if(area > bestArea){ bestArea = area; bestRect = rect; bestIdx = i; }
          cnt.delete();
        }

        let value = 'â€“';
        if(bestRect && bestArea > 2000){
          // ROI å†…ã§ãƒ‰ãƒƒãƒˆæ•°ã‚’æ•°ãˆã‚‹
          const roi = src.roi(bestRect);
          cv.cvtColor(roi, gray, cv.COLOR_RGBA2GRAY);
          cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0);
          // é©å¿œçš„äºŒå€¤åŒ–ï¼ˆé»’ã„ãƒ‰ãƒƒãƒˆã‚’ç™½ã«ï¼‰
          const bs = Math.max(7, parseInt(blockSize.value,10)|0);
          const C = parseInt(threshC.value, 10)|0;
          cv.adaptiveThreshold(blur, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, bs, C);
          // ROIå¤–ãƒã‚¤ã‚ºé™¤å»: å‰æ™¯ãƒã‚¹ã‚¯ã‚’ROIã«ã‚‚é©ç”¨
          const roiMask = maskFg.roi(bestRect);
          cv.bitwise_and(thresh, roiMask, thresh);
          cv.morphologyEx(thresh, thresh, cv.MORPH_OPEN, kernel);

          // ãƒ‰ãƒƒãƒˆå€™è£œè¼ªéƒ­
          const dots = new cv.MatVector(); const hier2 = new cv.Mat();
          cv.findContours(thresh, dots, hier2, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
          let count = 0;
          const roiArea = bestRect.width * bestRect.height;
          for(let i=0;i<dots.size();i++){
            const c = dots.get(i);
            const area = cv.contourArea(c);
            if(area < roiArea*0.002 || area > roiArea*0.2){ c.delete(); continue; }
            const peri = cv.arcLength(c, true);
            const circ = (4*Math.PI*area)/ (peri*peri + 1e-6); // å††å½¢åº¦
            if(circ > 0.4){ count++; }
            c.delete();
          }
          dots.delete(); hier2.delete(); roiMask.delete();
          roi.delete();

          if(count>=1 && count<=6){ value = String(count); } else { value = `? (${count})`; }
          drawBoxAndText(bestRect, value);
        } else {
          ctx2d.clearRect(0,0,overlay.width, overlay.height);
        }
        predEl.textContent = value;
        // å®‰å®šåŒ–ç”¨ã«æœ€è¿‘å€¤ã‚’è¨˜éŒ²ï¼ˆ1-6ã®ã¿ï¼‰
        const valNum = parseInt(value,10);
        if(!isNaN(valNum) && valNum>=1 && valNum<=6){
          recent.push(valNum);
          if(recent.length>RECENT_MAX){ recent.shift(); }
        }
        updateFPS();
      } catch(e){
        console.error(e);
        setStatus('å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
      requestAnimationFrame(loop);
    }

    // èƒŒæ™¯è‰²ã‚µãƒ³ãƒ—ãƒ«: ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã®è‰²ã‚’æ‹¾ã†
    sampleBtn.addEventListener('click', ()=>{
      pickingBg = true; setStatus('èƒŒæ™¯è‰²ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
    });
    overlay.addEventListener('click', (ev)=>{
      if(!pickingBg) return;
      const rect = overlay.getBoundingClientRect();
      const x = Math.floor((ev.clientX - rect.left) * overlay.width / rect.width);
      const y = Math.floor((ev.clientY - rect.top) * overlay.height / rect.height);
      const frame = new cv.Mat(); cap.read(frame);
      const pixel = frame.ucharPtr(y, x);
      const r = pixel[0], g = pixel[1], b = pixel[2];
      const hex = `#${[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('')}`;
      bgColor.value = hex;
      setStatus('èƒŒæ™¯è‰²ã‚µãƒ³ãƒ—ãƒ«å®Œäº†');
      frame.delete(); pickingBg = false;
    });

    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    flipBtn.addEventListener('click', async ()=>{ facingMode = (facingMode==='environment')? 'user' : 'environment'; await startCamera(); });

    window.addEventListener('resize', resizeCanvases);

    // ===== ã“ã“ã‹ã‚‰ãƒ­ã‚®ãƒ³ã‚°å‘¨ã‚Š =====
    function stableValue(){
      if(recent.length === 0) return null;
      // æœ€é »å€¤ï¼ˆãƒ¢ãƒ¼ãƒ‰ï¼‰ã§å®‰å®šåŒ–
      const freq = new Map();
      for(const v of recent){ freq.set(v,(freq.get(v)||0)+1); }
      let bestV=null, bestC=0; for(const [k,c] of freq){ if(c>bestC){ bestC=c; bestV=k; } }
      // ååˆ†ã«å¤šæ•°ï¼ˆ> åŠåˆ†ï¼‰å‡ºã¦ã„ã‚‹ã¨ãã®ã¿æ¡ç”¨
      if(bestC >= Math.ceil(recent.length*0.5)) return bestV;
      return null;
    }

    function incCount(v){ localCounts[v]++; countEls[v].textContent = localCounts[v]; }

    async function sendToSheet(v){
      const url = (endpointUrl.value||'').trim();
      if(!url) { setStatus('URLæœªè¨­å®šã®ãŸã‚é€ä¿¡ã—ã¾ã›ã‚“'); return; }
      const params = new URLSearchParams();
      params.append('value', String(v));
      params.append('ts', new Date().toISOString());
      params.append('agent', navigator.userAgent);
      const token = (endpointToken.value||'').trim(); if(token) params.append('token', token);
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params.toString() });
        // Apps Scriptã¯JSONè¿”ã•ãªã„ã“ã¨ã‚‚ã‚ã‚‹ã®ã§best-effort
        if(res.ok){ incCount(v); setStatus('é€ä¿¡OK'); }
        else { setStatus('é€ä¿¡å¤±æ•—: ' + res.status); }
      }catch(e){ console.error(e); setStatus('é€ä¿¡ã‚¨ãƒ©ãƒ¼'); }
    }

    function startLogging(){
      const sec = Math.max(1, parseInt(logInterval.value,10)||5);
      if(logTimer) clearInterval(logTimer);
      logTimer = setInterval(()=>{
        const v = stableValue();
        if(v!=null){ sendToSheet(v); }
        else { setStatus('æœªç¢ºå®šã®ãŸã‚é€ä¿¡ã‚¹ã‚­ãƒƒãƒ—'); }
      }, sec*1000);
      logToggleBtn.textContent = 'ãƒ­ã‚®ãƒ³ã‚°åœæ­¢';
      setStatus(`ãƒ­ã‚®ãƒ³ã‚°ä¸­ï¼ˆ${sec}sé–“éš”ï¼‰`);
    }

    function stopLogging(){ if(logTimer){ clearInterval(logTimer); logTimer=null; } logToggleBtn.textContent='ãƒ­ã‚®ãƒ³ã‚°é–‹å§‹'; setStatus('ãƒ­ã‚®ãƒ³ã‚°åœæ­¢'); }

    logToggleBtn.addEventListener('click', ()=>{ logTimer? stopLogging() : startLogging(); });
  </script>
</body>
</html>
